<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Citations - Parking Management</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <header>
        <div class="nav-container">
            <div class="logo-container">
                <div>Parking Management</div>
            </div>

            <ul class="nav-links">
                <li><a href="userDashboard.html">Dashboard</a></li>
                <li><a href="main.html">Logout</a></li>
            </ul>
        </div>
    </header>

    <div class="main-content">
        <div class="citations-container">
            <h2>Your Citations</h2>

            <table class="citations-table">
                <thead>
                    <tr>
                        <th>Citation Number (#)</th>
                        <th>Date</th>
                        <th>Reason</th>
                        <th>Vehicle</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <footer>
        <div class="footer-container">
            <h2>Contact Us</h2>
            <div class="contact-row">
                <div class="contact-label">Email:</div>
                <div class="contact-value">parking@portal.com</div>
                <div class="contact-label">Phone:</div>
                <div class="contact-value">(XXX) XXX-XXX</div>
                <div class="contact-label">Location:</div>
                <div class="contact-value">800 W Campbell Rd, Richardson, TX 75080</div>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.uid) {
                window.location.href = '/';
                return;
            }

            try {
                const response = await fetch(`/api/citations/${user.uid}`);
                const citations = await response.json();

                const tbody = document.querySelector('.citations-table tbody');
                tbody.innerHTML = '';

                if (citations.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="7" class="no-citations">No citations found.</td>';
                    tbody.appendChild(row);
                } else {
                    citations.forEach(citation => {
                        const row = document.createElement('tr');
                        const isPaid = citation.status === 'Paid';
                        const isAppealed = citation.status === 'Appealed';

                        let actionBtn;
                        let statusColor;

                        if (isPaid) {
                            actionBtn = '<button class="citation-btn" disabled style="background-color: #95a5a6; cursor: not-allowed;">Paid</button>';
                            statusColor = '#27ae60';
                        } else if (isAppealed) {
                            actionBtn = '<button class="citation-btn" disabled style="background-color: #f39c12; cursor: not-allowed;">Appealed</button>';
                            statusColor = '#f39c12';
                        } else {
                            actionBtn = `<button class="citation-btn" onclick="payCitation(${citation.citation_id})" style="background-color: #27ae60; padding: 8px 15px;">Pay</button>`;
                            statusColor = '#e74c3c';
                        }

                        row.innerHTML = `
                            <td>${citation.citation_number}</td>
                            <td>${new Date(citation.citation_date).toLocaleDateString()}</td>
                            <td>${citation.reason}</td>
                            <td>${citation.license_plate}</td>
                            <td class="amount">$${citation.amount}</td>
                            <td style="color: ${statusColor}; font-weight: bold;">${citation.status}</td>
                            <td>${actionBtn}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error fetching citations:', error);
            }
        });

        async function payCitation(id) {
            if (!confirm('Are you sure you want to pay this citation?')) return;

            try {
                const response = await fetch(`/api/citations/${id}/pay`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('Citation paid successfully!');
                    location.reload();
                } else {
                    alert('Failed to pay citation');
                }
            } catch (error) {
                console.error('Error paying citation:', error);
                alert('Error paying citation');
            }
        }
    </script>
</body>
</html>